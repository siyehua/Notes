# 安卓客户端比分详情页面加载速度优化

球球是道APP安卓比分详情,相对于同类产品,无论是打开速度和渲染速度都要慢

随着业务的增多,卡顿现象越来越严重,针对这个进行分析优化


## 现象

取球探5.3版本,球球是道2.9.0版本进行对比分析(单位:ms)

球探|球球|球探(网络)|球球(网络)|球球(基本面后移)
---|---|---|---|---
97|938.36|14.59|426.91|332.19

上表数据分析,球球是道基本面的渲染时间是球探的9.67倍之多

而排除网络请求时间,球球的页面渲染时间也高达511毫秒,是球探的6倍多.

## 分析

APP渲染时间过长,主要表现在页面的复杂度,突出体现在交互与View的绘制界面

APP|交互方式|页面数量|首页View数量|复杂度|网络用时
---|---|---|---|---|---
球探|点击菜单切换,不能滑动<br>头部不能缩放|6|212|有规律,可复用|14.91
球球是道|页面可滑动,也可点击菜单切换<br>头部可缩放<br>整个页面能隐藏并弹出底部滚球|13|407|精细复杂,不可复用|426.91

#### 球探比分详情首页View分析
![Image](/Other/StartActivity Problem/_001.png)

#### 球球是道比分详情首页View分析
![Image](/Other/StartActivity Problem/_002.png)

球球是道APP交互方式与业务逻辑比球探更加复杂,网络请求时长更高,页面更加精细.

经过分析,渲染时间过长最关键是基本面的渲染时长,如果将基本也后移,盘面移动到首页显示,加载速度立即提高到仅有332毫秒.

交互方式,显示内容,业务逻辑,以及网络相应速度不受APP自身控制,在不能降低复杂的情况下,可以让CPU,GPU以及内存的使用处于
一个平缓过度的阶段,而不是在瞬间占用非常高,导致卡顿

所以可以采用先加载部分逻辑以及视觉,剩下部分再分布加载,让网络请求与渲染加载的逻辑相互分离,这样渲染时间就不依赖于网络请求时间,从而达到快速渲染比分详情的目的.


## 优化分析图

#### 比分详情整体框架
![Image](/Other/StartActivity Problem/_003.png)

进入比分详情,仅加载交互框架,以及基本面,其他页面采用懒加载的方式,只创建出对象,但不进行View以及数据的加载

只加载必要的元素,能将资源的消耗降低到最低,加快比分详情的页面渲染速度

#### 基本面框架
![Image](/Other/StartActivity Problem/_004.png)

基本面主要分五大模块,其中前四大模块的数据过大,逻辑复杂,所以渲染速度特别慢.

所以采用监听主线程卡顿的方式来判断比分详情主框架是否完成了渲染,然后逐步加载页面,保证渲染平滑,及时.

![基本面加载流程](/Other/StartActivity Problem/_005.png)

## 优化结果

球探|球球|球探(网络)|球球(网络)|球球(基本面后移)|改版后
---|---|---|---|---|---
97|938.36|14.59|426.91|332.19|192.8

优化后,比分详情主线程的渲染与网络请求响应分离,页面逐步加载,从而极大提高了页面启动的渲染时间.

目前总体的渲染时间大概是球探1.98倍,但是复杂度是2.05倍(页面View的数目),就单个view的渲染速度,已经快过了球探


##### 参考资料:
QQ空间终端开发团队[Android卡慢监控组件简介](http://mp.weixin.qq.com/s?__biz=MzI1MTA1MzM2Nw==&mid=2649796870&idx=1&sn=fd911850e32dd955316664c8c4104946&chksm=f1fcc55ec68b4c4865fd7466cc21f5e0b72080a034757613678cd011162858561310513834af&scene=4#wechat_redirect)
